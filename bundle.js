// Copyright (c) 2022 The Stdlib Authors. License is Apache-2.0: http://www.apache.org/licenses/LICENSE-2.0
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).httpServer=t()}(this,(function(){"use strict";function e(e){if(e.__esModule)return e;var t=Object.defineProperty({},"__esModule",{value:!0});return Object.keys(e).forEach((function(n){var r=Object.getOwnPropertyDescriptor(e,n);Object.defineProperty(t,n,r.get?r:{enumerable:!0,get:function(){return e[n]}})})),t}var t="/home/runner/work/net-disposable-http-server/net-disposable-http-server/lib",n=require("path"),r=require("debug"),i=require("@stdlib/utils-keys"),o=require("@stdlib/net-http-server"),s=require("@stdlib/fs-read-file").sync,u=require("@stdlib/assert-is-string").isPrimitive,c=require("@stdlib/assert-is-function"),l=require("@stdlib/utils-open-url"),d=require("@stdlib/utils-noop"),a=require("@stdlib/buffer-ctor"),f=require("@stdlib/buffer-from-string"),p=require("@stdlib/utils-next-tick"),h=require("./validate.js"),v=require("./opts.js"),b=require("./connections_store.js"),g=r("disposable-http-server");return module.exports=function(e){var r,m,j,y,q,S,C,T,_;if(T={},arguments.length>1){if(!c(S=arguments[1]))throw new TypeError("invalid argument. Callback argument must be a function. Value: `"+S+"`.")}else S=d;if(_=h(T,e))throw _;function x(e,t){var n;if(e)throw e;g("Server started."),(j=t).on("connection",L),j.once("close",E),T.open&&(n=j.address(),l("http://"+n.address+":"+n.port)),S(null,j)}function L(e){var t=e.remoteAddress+":"+e.remotePort;g("Received a socket connection: %s.",t),r[t]=e,e.on("close",(function(){g("Socket connection closed: %s.",t),delete r[t]}))}function k(e,t){if(g("Received a request for %s",e.url),m)return w(e,t);if("/bundle.js"===e.url)return p(n(M)),t.once("finish",P);if("/"!==e.url&&"/index.html"!==e.url)return H(e,t);function n(n){return function(){n(e,t)}}p(n(O)),T.javascript||t.once("finish",P)}function H(e,t){g("Sending 404 response..."),t.statusCode=404,t.end()}function w(e,t){g("Sending 503 response..."),t.statusCode=503,t.end()}function O(e,t){g("Sending HTML..."),t.statusCode=200,t.setHeader("Content-Type","text/html"),t.setHeader("Content-Length",a.byteLength(T.html.toString())),t.end(T.html)}function M(e,t){g("Sending JavaScript..."),t.statusCode=200,t.setHeader("Content-Type","text/javascript"),t.setHeader("Content-Length",a.byteLength(T.javascript.toString())),t.end(T.javascript)}function P(){g("Finished serving content."),m=!0,g("Closing the server..."),j.close(),setTimeout(D,5e3)}function D(){var e,t;for(g("Destroying all connections..."),e=i(r),t=0;t<e.length;t++)g("Destroying connection %s...",e[t]),r[e[t]].destroy()}function E(){g("Server closed.")}T.html&&u(T.html)&&(T.html=f(T.html)),T.javascript&&u(T.javascript)&&(T.javascript=f(T.javascript)),y=v(e),g("Serving provided content."),T.html||(g("No HTML content provided."),g("Loading a boilerplate HTML page..."),q=n.resolve(t,"../static/index.html"),T.html=s(q)),C=o(y,k),g("Starting server..."),C(x),r=b()},e(Object.freeze({__proto__:null}))}));
//# sourceMappingURL=bundle.js.map
