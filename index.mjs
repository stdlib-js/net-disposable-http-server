// Copyright (c) 2022 The Stdlib Authors. License is Apache-2.0: http://www.apache.org/licenses/LICENSE-2.0
/// <reference types="./index.d.ts" />
function e(e){if(e.__esModule)return e;var t=Object.defineProperty({},"__esModule",{value:!0});return Object.keys(e).forEach((function(r){var n=Object.getOwnPropertyDescriptor(e,r);Object.defineProperty(t,r,n.get?n:{enumerable:!0,get:function(){return e[r]}})})),t}var t="/home/runner/work/net-disposable-http-server/net-disposable-http-server/lib",r=require("path"),n=require("debug"),i=require("@stdlib/utils-keys"),s=require("@stdlib/net-http-server"),o=require("@stdlib/fs-read-file").sync,u=require("@stdlib/assert-is-string").isPrimitive,a=require("@stdlib/assert-is-function"),c=require("@stdlib/utils-open-url"),l=require("@stdlib/utils-noop"),d=require("@stdlib/buffer-ctor"),f=require("@stdlib/buffer-from-string"),p=require("@stdlib/utils-next-tick"),v=require("./validate.js"),h=require("./opts.js"),b=require("./connections_store.js"),g=n("disposable-http-server");module.exports=function(e){var n,m,j,q,y,S,C,_,L;if(_={},arguments.length>1){if(!a(S=arguments[1]))throw new TypeError("invalid argument. Callback argument must be a function. Value: `"+S+"`.")}else S=l;if(L=v(_,e))throw L;function k(e,t){var r;if(e)throw e;g("Server started."),(j=t).on("connection",x),j.once("close",E),_.open&&(r=j.address(),c("http://"+r.address+":"+r.port)),S(null,j)}function x(e){var t=e.remoteAddress+":"+e.remotePort;g("Received a socket connection: %s.",t),n[t]=e,e.on("close",(function(){g("Socket connection closed: %s.",t),delete n[t]}))}function H(e,t){if(g("Received a request for %s",e.url),m)return w(e,t);if("/bundle.js"===e.url)return p(r(M)),t.once("finish",P);if("/"!==e.url&&"/index.html"!==e.url)return T(e,t);function r(r){return function(){r(e,t)}}p(r(O)),_.javascript||t.once("finish",P)}function T(e,t){g("Sending 404 response..."),t.statusCode=404,t.end()}function w(e,t){g("Sending 503 response..."),t.statusCode=503,t.end()}function O(e,t){g("Sending HTML..."),t.statusCode=200,t.setHeader("Content-Type","text/html"),t.setHeader("Content-Length",d.byteLength(_.html.toString())),t.end(_.html)}function M(e,t){g("Sending JavaScript..."),t.statusCode=200,t.setHeader("Content-Type","text/javascript"),t.setHeader("Content-Length",d.byteLength(_.javascript.toString())),t.end(_.javascript)}function P(){g("Finished serving content."),m=!0,g("Closing the server..."),j.close(),setTimeout(D,5e3)}function D(){var e,t;for(g("Destroying all connections..."),e=i(n),t=0;t<e.length;t++)g("Destroying connection %s...",e[t]),n[e[t]].destroy()}function E(){g("Server closed.")}_.html&&u(_.html)&&(_.html=f(_.html)),_.javascript&&u(_.javascript)&&(_.javascript=f(_.javascript)),q=h(e),g("Serving provided content."),_.html||(g("No HTML content provided."),g("Loading a boilerplate HTML page..."),y=r.resolve(t,"../static/index.html"),_.html=o(y)),C=s(q,H),g("Starting server..."),C(k),n=b()};var m=e(Object.freeze({__proto__:null}));export{m as default};
//# sourceMappingURL=index.mjs.map
